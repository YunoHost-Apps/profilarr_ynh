#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

### Settings are automatically loaded as bash variables
### in every app script context, therefore typically these will exist:
### - $domain
### - $path
### - $language
### - $install_dir
### - $port
### ...

### In the context of upgrade,
### - resources are automatically provisioned / updated / deleted (depending on existing resources)
### - a safety backup is automatically created by the core and will be restored if the upgrade fails

#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping $app's systemd service..."

ynh_systemctl --service="$app" --action="stop"

#=================================================
# ENSURE DOWNWARD COMPATIBILITY
#=================================================
ynh_script_progression "Ensuring downward compatibility..."

# Nothing to do for now

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Upgrading source files..."

# Download the source code to /tmp/$app
ynh_setup_source --dest_dir="/tmp/$app"

# Backup venv if it exists
if [ -d "$install_dir/backend/venv" ]; then
    mv "$install_dir/backend/venv" "/tmp/${app}_venv_backup"
fi

# Update backend files
rm -rf "$install_dir/backend"
mkdir -p "$install_dir/backend"
cp -r /tmp/$app/backend/* "$install_dir/backend/"

# Restore venv if it was backed up
if [ -d "/tmp/${app}_venv_backup" ]; then
    mv "/tmp/${app}_venv_backup" "$install_dir/backend/venv"
fi

# Update frontend files
rm -rf "$install_dir/web"
mkdir -p "$install_dir/web"
cp -r /tmp/$app/frontend/* "$install_dir/web/"

rm -rf /tmp/$app

chown -R "$app:www-data" "$install_dir"

pushd $install_dir
    # Update backend dependencies
    ynh_script_progression "Updating backend dependencies..."
    ynh_replace_regex --match="PyYAML==5.4.1" --replace="PyYAML==6.0.1" --file="$install_dir/backend/requirements.txt"
    ynh_hide_warnings ynh_exec_as_app "$install_dir/backend/venv/bin/pip" install --no-cache-dir --upgrade pip setuptools wheel
    ynh_hide_warnings ynh_exec_as_app "$install_dir/backend/venv/bin/pip" install --no-cache-dir --upgrade -r "$install_dir/backend/requirements.txt"

    # Update frontend dependencies
    ynh_script_progression "Updating frontend dependencies..."
    pushd "$install_dir/web"
        ynh_hide_warnings ynh_exec_as_app npm install

        ynh_script_progression "Building frontend..."
        ynh_hide_warnings ynh_exec_as_app npm run build
    popd
popd

#=================================================
# UPDATE A CONFIG FILE
#=================================================
ynh_script_progression "Updating $app's configuration files..."

# Ensure log directory exists with proper permissions
mkdir -p "/var/log/$app"
chown -R "$app:$app" "/var/log/$app"
chmod 755 "/var/log/$app"

# Ensure config directory exists with proper permissions  
mkdir -p "$data_dir/config"
mkdir -p "$data_dir/config/log"
chown -R "$app:$app" "$data_dir/config"
chmod 755 "$data_dir/config"
chmod 755 "$data_dir/config/log"

# Ensure symbolic link to logs exists
if [ ! -L "$data_dir/logs" ]; then
    ln -s "/var/log/$app" "$data_dir/logs"
fi

#=================================================
# REAPPLY SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Upgrading system configurations related to $app..."

### This should be a literal copypaste of what happened in the install's "System configuration" section

ynh_config_add_nginx

ynh_config_add_systemd

yunohost service add "$app" --description="Profilarr backend" --log="/var/log/$app/$app.log"

ynh_config_add_logrotate "/var/log/$app/"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting $app's systemd service..."

ynh_systemctl --service="$app" --action="start"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
